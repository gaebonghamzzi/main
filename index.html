<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆìŒ í•´ê²°ì‚¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            font-family: 'Jua', sans-serif;
            /* ë°°ê²½ì„ í•˜íŠ¸ ì´ëª¨ì§€ë¡œ ë³€ê²½ */
            background-color: #fff2f2;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='80' opacity='0.08'%3EğŸ’–%3C/text%3E%3C/svg%3E");
            background-size: 100px 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .view { display: none; }
        .view.active { display: block; }

        h1 { color: #333; font-size: 2rem; margin-bottom: 15px; text-align: center; }
        p { color: #555; font-size: 1.2rem; line-height: 1.6; text-align: center; }
        
        /* --- ë²„íŠ¼ ìƒ‰ìƒ ìˆ˜ì • --- */
        button { 
            font-family: 'Jua', sans-serif; 
            padding: 20px; 
            font-size: 1.3rem; 
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            transition: all 0.2s; 
            background-color: #ffe5e5; /* ê¸°ë³¸ ë²„íŠ¼ ìƒ‰ (ì—°í•œ í•‘í¬) */
            color: #5c3a3a;
            border-bottom: 5px solid #ffc1c1;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button:active { transform: translateY(1px); border-bottom-width: 2px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; border-bottom-color: #aaa; color: #888; }
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        .full-width-btn { grid-column: 1 / -1; }
        .back-btn { font-size: 1rem; padding: 10px 15px; background-color: #6c757d; color: white; border-bottom-color: #5a6268;}

        /* --- ë©”ì¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ ìˆ˜ì • --- */
        #landing-view .landing-header {
            text-align: left;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff6b81;
            margin-bottom: 40px;
        }
        #landing-view .landing-content h1 {
            font-size: 2.8rem;
            color: #333;
            line-height: 1.4;
        }
        #landing-view .landing-content p {
            font-size: 1.3rem;
            color: #666;
            margin-top: 20px;
            margin-bottom: 40px;
        }
        #landing-view .landing-buttons button {
            padding: 20px 30px;
            font-size: 1.5rem;
            color: white;
        }
        #landing-view .teacher-start-btn {
            background-color: #ff8fa3; /* êµì‚¬ ë²„íŠ¼ (í•‘í¬) */
            border-bottom-color: #ff758f;
        }
        #landing-view .student-start-btn {
            background-color: #ffc09f; /* í•™ìƒ ë²„íŠ¼ (í”¼ì¹˜) */
            border-bottom-color: #ffab82;
        }
        /* --- ë©”ì¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ ë --- */

        .form-box input {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            font-family: 'Jua', sans-serif;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
            margin-bottom: 15px;
            text-align: center;
        }
        .form-box { margin-top: 20px; }
        textarea { width: 100%; padding: 15px; font-family: 'Jua', sans-serif; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; margin-top: 15px; resize: vertical; }
        .notice { font-size: 1rem; color: #d9534f; font-weight: bold; background-color: #f9e4e4; padding: 10px; border-radius: 10px; }
        
        /* --- ë‹¨ê³„ë³„ ë²„íŠ¼ ìƒ‰ìƒ ìˆ˜ì • --- */
        button.reason-btn { background-color: #fff3cd; color: #856404; border-color: #f7d97e; }
        button.write-btn { background-color: #e2d1dd; color: #5c3d51; border-color: #c0a3bb; }
        button.dialogue-btn { background-color: #d1e7dd; color: #155724; border-color: #a3cfbb; }
        button.success-btn { background-color: #cff4fc; color: #0c5460; border-color: #9eeaf9; }
        button.help-btn { background-color: #f8d7da; color: #721c24; border-color: #f1aeb5; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #teacher-view { font-family: 'Noto Sans KR', sans-serif; }
        #teacher-view .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #teacher-view .header button { font-size: 1rem; padding: 10px 15px; background-color: #6c757d; color: white; border-bottom-color: #5a6268;}
        #teacher-view .report-container { max-height: 60vh; overflow-y: auto; }
        .report-card { background-color: #fdfdfd; border: 1px solid #eee; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; }
        .report-card .info { display: flex; justify-content: space-between; font-size: 0.9rem; color: #888; margin-bottom: 10px; }
        .report-card .content { font-size: 1rem; background-color: #f9f9f9; padding: 15px; border-radius: 5px; white-space: pre-wrap; margin-bottom: 15px; }
        .report-card .status { font-weight: bold; padding: 5px 10px; border-radius: 5px; text-align: center; margin-bottom: 15px; }
        .status.unresolved { background-color: #ffeeba; color: #856404; }
        .status.self-resolved { background-color: #d4edda; color: #155724; }
        .status.teacher-resolved { background-color: #d1ecf1; color: #0c5460; }
        .report-card .actions button { width: 100%; padding: 10px; font-size: 1rem; background-color: #28a745; color: white; border-bottom-color: #218838;}
        .report-card .actions button:disabled { background-color: #ccc; cursor: not-allowed; border-bottom-color: #aaa; color: #888;}
    </style>
</head>
<body>

    <div class="container">
        <!-- 1. ë©”ì¸(ëœë”©) ë·° -->
        <div id="landing-view" class="view active">
            <div class="landing-header">ğŸ’– ë§ˆìŒ í•´ê²°ì‚¬</div>
            <div class="landing-content">
                <h1>ìŠ¤ìŠ¤ë¡œ í•´ê²°í•˜ë©° ì„±ì¥í•˜ëŠ”<br>ìš°ë¦¬ë“¤ì˜ ê°ˆë“± í•´ê²° ì‹œê°„</h1>
                <p>ì¹œêµ¬ì™€ ë§ˆìŒì´ ë§ì§€ ì•Šì„ ë•Œ, ì°¨ê·¼ì°¨ê·¼ ë‚´ ë§ˆìŒì„ í‘œí˜„í•˜ê³ <br>ëŒ€í™”ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë©‹ì§„ ì–´ë¦°ì´ê°€ ë˜ì–´ë³´ì•„ìš”!</p>
            </div>
            <div class="button-grid landing-buttons">
                <button id="teacher-start-btn" class="teacher-start-btn">êµì‚¬ë¡œ ì‹œì‘í•˜ê¸°</button>
                <button id="student-start-btn" class="student-start-btn">í•™ìƒìœ¼ë¡œ ì…ì¥í•˜ê¸°</button>
            </div>
        </div>

        <!-- 2. êµì‚¬ìš© í—ˆë¸Œ ë·° -->
        <div id="teacher-hub-view" class="view">
            <h1>êµì‚¬ìš© ë©”ë‰´</h1>
            <p>ë¬´ì—‡ì„ í• ê¹Œìš”?</p>
            <div class="button-grid">
                <button id="go-to-teacher-login-btn">ë¡œê·¸ì¸</button>
                <button id="go-to-signup-btn">í•™ê¸‰ ë§Œë“¤ê¸°</button>
            </div>
            <button class="back-btn full-width-btn" onclick="showView(document.getElementById('landing-view'))">ì²˜ìŒìœ¼ë¡œ</button>
        </div>

        <!-- 3. êµì‚¬ íšŒì›ê°€ì… ë·° -->
        <div id="signup-view" class="view">
            <h1>ìƒˆë¡œìš´ í•™ê¸‰ ë§Œë“¤ê¸°</h1>
            <div class="form-box">
                <input type="text" id="signup-class-code" placeholder="ìƒˆë¡œìš´ í•™ê¸‰ ì½”ë“œ">
                <input type="password" id="signup-password" placeholder="ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸">
                <button id="signup-btn" class="full-width-btn">ë§Œë“¤ê¸°</button>
                <button class="back-btn full-width-btn" onclick="showView(document.getElementById('teacher-hub-view'))">ë’¤ë¡œ ê°€ê¸°</button>
            </div>
        </div>

        <!-- 4. í•™ìƒ ë¡œê·¸ì¸ ë·° (ë¶„ë¦¬ë¨) -->
        <div id="student-login-view" class="view">
            <h1>í•™ìƒ ë¡œê·¸ì¸</h1>
            <div class="form-box">
                <input type="text" id="student-class-code" placeholder="í•™ê¸‰ ì½”ë“œ">
                <input type="text" id="student-name" placeholder="ì´ë¦„">
                <button id="student-login-btn" class="full-width-btn">ì…ì¥í•˜ê¸°</button>
            </div>
            <button class="back-btn full-width-btn" onclick="showView(document.getElementById('landing-view'))">ì²˜ìŒìœ¼ë¡œ</button>
        </div>

        <!-- 5. êµì‚¬ ë¡œê·¸ì¸ ë·° (ë¶„ë¦¬ë¨) -->
        <div id="teacher-login-view" class="view">
            <h1>êµì‚¬ ë¡œê·¸ì¸</h1>
            <div class="form-box">
                <input type="text" id="teacher-class-code" placeholder="í•™ê¸‰ ì½”ë“œ">
                <input type="password" id="teacher-password" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button id="teacher-login-btn" class="full-width-btn">ì…ì¥í•˜ê¸°</button>
            </div>
            <button class="back-btn full-width-btn" onclick="showView(document.getElementById('teacher-hub-view'))">ë’¤ë¡œ ê°€ê¸°</button>
        </div>

        <!-- 6. í•™ìƒìš© ë·° -->
        <div id="student-view" class="view"></div>
        <!-- 7. êµì‚¬ìš© ë·° -->
        <div id="teacher-view" class="view"></div>
    </div>

    <!-- Firebase SDK ì¶”ê°€ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ì„ ìƒë‹˜ì˜ Firebase ì„¤ì • ì •ë³´ì…ë‹ˆë‹¤.
        const firebaseConfig = {
          apiKey: "AIzaSyAc35ldx-s4Opni4SZ7L8OiwNmjqV5UPJs",
          authDomain: "maeumapple.firebaseapp.com",
          projectId: "maeumapple",
          storageBucket: "maeumapple.appspot.com",
          messagingSenderId: "742281453219",
          appId: "1:742281453219:web:80fa8a3f52d9cda19ae916",
          measurementId: "G-1X3661KSN9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let currentReportId = null;
        let unsubscribeReports = null;
        let unsubscribeAlerts = null;

        // DOM ìš”ì†Œ
        const allViews = document.querySelectorAll('.view');
        const landingView = document.getElementById('landing-view');
        const teacherHubView = document.getElementById('teacher-hub-view');
        const signupView = document.getElementById('signup-view');
        const studentLoginView = document.getElementById('student-login-view');
        const teacherLoginView = document.getElementById('teacher-login-view');
        const studentView = document.getElementById('student-view');
        const teacherView = document.getElementById('teacher-view');
        
        const authButtons = [
            document.getElementById('teacher-start-btn'),
            document.getElementById('student-start-btn'),
            document.getElementById('go-to-teacher-login-btn'),
            document.getElementById('go-to-signup-btn'),
            document.getElementById('signup-btn'),
            document.getElementById('student-login-btn'),
            document.getElementById('teacher-login-btn')
        ];

        // ë·° ì „í™˜ í•¨ìˆ˜
        window.showView = (viewToShow) => {
            allViews.forEach(v => v.classList.remove('active'));
            viewToShow.classList.add('active');
        };

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        document.getElementById('teacher-start-btn').onclick = () => showView(teacherHubView);
        document.getElementById('student-start-btn').onclick = () => showView(studentLoginView);
        document.getElementById('go-to-teacher-login-btn').onclick = () => showView(teacherLoginView);
        document.getElementById('go-to-signup-btn').onclick = () => showView(signupView);
        
        // --- íšŒì›ê°€ì… ë¡œì§ ---
        document.getElementById('signup-btn').onclick = async () => {
            const signupButton = document.getElementById('signup-btn');
            const classCode = document.getElementById('signup-class-code').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            if (!classCode || !password) {
                alert("í•™ê¸‰ ì½”ë“œì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            signupButton.disabled = true;
            signupButton.innerText = 'í™•ì¸ ì¤‘...';

            const classRef = doc(db, "classes", classCode);
            
            try {
                const docSnap = await getDoc(classRef);
                if (docSnap.exists()) {
                    alert('ê°€ì… ì‹¤íŒ¨, ì´ë¯¸ ì‚¬ìš©ëœ í•™ê¸‰ ì½”ë“œì…ë‹ˆë‹¤. ë‹¤ë¥¸ í•™ê¸‰ ì½”ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                } else {
                    await setDoc(classRef, { password: password });
                    alert('ê°€ì… ì„±ê³µ! í•™ê¸‰ì½”ë“œì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ êµì‚¬ ë¡œê·¸ì¸ì„ í•´ ë³´ì„¸ìš”.');
                    document.getElementById('signup-class-code').value = '';
                    document.getElementById('signup-password').value = '';
                    showView(teacherLoginView);
                }
            } catch (e) {
                console.error("Error during signup: ", e);
                alert("íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                signupButton.disabled = false;
                signupButton.innerText = 'ë§Œë“¤ê¸°';
            }
        };

        // --- ë¡œê·¸ì¸ ë¡œì§ ---
        document.getElementById('student-login-btn').onclick = async () => {
            const loginButton = document.getElementById('student-login-btn');
            const classCode = document.getElementById('student-class-code').value.trim();
            const name = document.getElementById('student-name').value.trim();
            if (!classCode || !name) { alert("í•™ê¸‰ ì½”ë“œì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            
            loginButton.disabled = true;
            loginButton.innerText = 'í™•ì¸ ì¤‘...';

            const classRef = doc(db, "classes", classCode);
            
            try {
                const docSnap = await getDoc(classRef);
                if (docSnap.exists()) {
                    currentUser = { role: 'student', name: name, classCode: classCode };
                    startStudentApp();
                } else {
                    alert("í•™ê¸‰ ì½”ë“œê°€ ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }
            } catch (e) {
                console.error("Error during student login: ", e);
                alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                loginButton.disabled = false;
                loginButton.innerText = 'ì…ì¥í•˜ê¸°';
            }
        };

        document.getElementById('teacher-login-btn').onclick = async () => {
            const loginButton = document.getElementById('teacher-login-btn');
            const classCode = document.getElementById('teacher-class-code').value.trim();
            const password = document.getElementById('teacher-password').value.trim();
            if (!classCode || !password) { alert("í•™ê¸‰ ì½”ë“œì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            loginButton.disabled = true;
            loginButton.innerText = 'í™•ì¸ ì¤‘...';

            const classRef = doc(db, "classes", classCode);
            
            try {
                const docSnap = await getDoc(classRef);
                if (docSnap.exists() && docSnap.data().password === password) {
                    currentUser = { role: 'teacher', classCode: classCode };
                    startTeacherApp();
                } else {
                    alert("í•™ê¸‰ ì½”ë“œ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
            } catch (e) {
                console.error("Error during teacher login: ", e);
                alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                loginButton.disabled = false;
                loginButton.innerText = 'ì…ì¥í•˜ê¸°';
            }
        };
        
        // --- í•™ìƒ ì•± ì‹œì‘ ---
        function startStudentApp() {
            studentView.innerHTML = `
                <div id="s-step1" class="s-step" style="display: block;">
                    <h1>ì†ìƒí•œ ì¼ì´ ìˆì—ˆêµ¬ë‚˜, ${currentUser.name}.</h1>
                    <p>ì§€ê¸ˆ ë„ˆì˜ ë§ˆìŒê³¼ ê°€ì¥ ë¹„ìŠ·í•œ ê°ì •ì€ ë¬´ì—‡ì´ë‹ˆ?</p>
                    <div class="button-grid">
                        <button class="reason-btn" onclick="mindSolverApp.selectEmotion('ğŸ˜¡ í™”ê°€ ë‚˜ìš”')">ğŸ˜¡ í™”ê°€ ë‚˜ìš”</button>
                        <button class="reason-btn" onclick="mindSolverApp.selectEmotion('ğŸ˜­ ìŠ¬í¼ìš”')">ğŸ˜­ ìŠ¬í¼ìš”</button>
                        <button class="reason-btn" onclick="mindSolverApp.selectEmotion('ğŸ˜Ÿ ì–µìš¸í•´ìš”')">ğŸ˜Ÿ ì–µìš¸í•´ìš”</button>
                        <button class="reason-btn" onclick="mindSolverApp.selectEmotion('ğŸ˜° ë‹µë‹µí•´ìš”')">ğŸ˜° ë‹µë‹µí•´ìš”</button>
                    </div>
                </div>
                <div id="s-step2" class="s-step" style="display: none;"><h1>ì–´ë–¤ ì¼ì´ ìˆì—ˆëŠ”ì§€ ì•Œë ¤ì¤„ë˜?</h1><p class="notice">ì–¸ì œ, ì–´ë””ì„œ, ëˆ„ê°€, ì–´ë–¤ ë§ì´ë‚˜ í–‰ë™ì„ í–ˆëŠ”ì§€<br>ì •í™•í•œ ì‚¬ì‹¤ë§Œ ì ì–´ì¤˜.</p><textarea id="incident-report" rows="6" placeholder="ì—¬ê¸°ì— ìˆì—ˆë˜ ì¼ì„ ì°¨ê·¼ì°¨ê·¼ ì ì–´ë³´ì..."></textarea><div class="button-grid"><button class="write-btn full-width-btn" onclick="mindSolverApp.saveReport()">ë‹¤ ì ì—ˆì–´ìš”</button></div></div>
                <div id="s-step3" class="s-step" style="display: none;"><h1>ì˜ ì ì–´ì£¼ì—ˆì–´. ì´ì œ ë„ˆì˜ ë§ˆìŒì„ ì¹œêµ¬ì—ê²Œ ì´ì•¼ê¸°í•´ë³¼ê¹Œ?</h1><p>"ë‚˜ëŠ” ë„¤ê°€ (  )í–‰ë™ì„ í•´ì„œ, (  )ê°ì •ì´ ë“¤ì—ˆì–´."<br>ì´ë ‡ê²Œ ì†”ì§í•˜ê²Œ ë§í•´ë³´ëŠ” ê±´ ì–´ë•Œ?</p><div class="button-grid"><button class="dialogue-btn full-width-btn" onclick="mindSolverApp.nextStudentStep(4)">ì¢‹ì•„ìš”, ìš©ê¸° ë‚´ë³¼ê²Œìš”!</button></div></div>
                <div id="s-step4" class="s-step" style="display: none;"><h1>ì¹œêµ¬ì™€ ì´ì•¼ê¸°í•´ë³´ë‹ˆ ì–´ë• ì–´?</h1><p>ë§ˆìŒì´ ì˜ í•´ê²°ë˜ì—ˆëŠ”ì§€ ì•Œë ¤ì¤˜!</p><div class="button-grid"><button class="success-btn" onclick="mindSolverApp.updateStatus('ìì²´ í•´ê²° ì™„ë£Œ')">ë„¤, ì˜ í•´ê²°ëì–´ìš”!</button><button class="help-btn" onclick="mindSolverApp.nextStudentStep(6)">ì•„ë‹ˆìš”, ë„ì›€ì´ í•„ìš”í•´ìš”</button></div></div>
                <div id="s-step5" class="s-step" style="display: none;"><h1>ì •ë§ ë©‹ì§€ë‹¤!</h1><p>ëŒ€í™”ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•œ ë„ˆí¬ ëª¨ë‘ê°€ ìë‘ìŠ¤ëŸ¬ì›Œ!<br>ë‹¤ì‹œ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì¤˜.</p><div class="button-grid"><button class="full-width-btn" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button></div></div>
                <div id="s-step6" class="s-step" style="display: none;">
                    <h1>í˜¼ì í•´ê²°í•˜ê¸° ì–´ë ¤ìš¸ ë•,<br>ì„ ìƒë‹˜ì˜ ë„ì›€ì´ í˜ì´ ë  ìˆ˜ ìˆì–´.</h1>
                    <p>ê´œì°®ì•„, ìš©ê¸° ë‚´ì–´ ì„ ìƒë‹˜ê»˜ ë„ì›€ì„ ìš”ì²­ë“œë ¤ë³´ì.<br>ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì„ ìƒë‹˜ê»˜ ì•Œë¦¼ì´ ê°ˆ ê±°ì•¼.</p>
                    <div class="button-grid">
                        <button id="teacher-call-btn" class="full-width-btn" onclick="mindSolverApp.callTeacher()">ğŸš¨ ì„ ìƒë‹˜! ë„ì™€ì£¼ì„¸ìš”! ğŸš¨</button>
                    </div>
                </div>
                <div id="s-step7" class="s-step" style="display: none;">
                    <h1>ì„ ìƒë‹˜ê»˜ ì•Œë ¸ì–´ìš”!</h1>
                    <p>ì„ ìƒë‹˜ê³¼ ì´ì•¼ê¸°í•˜ê³  ë¬¸ì œê°€ í•´ê²°ë˜ë©´<br>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§ˆë¬´ë¦¬í•´ì£¼ì„¸ìš”.</p>
                    <div class="button-grid">
                        <button class="success-btn full-width-btn" onclick="location.reload()">í•´ê²°ëì–´ìš”!</button>
                    </div>
                </div>
            `;
            showView(studentView);
        }
        
        // í•™ìƒìš© ì•± í•¨ìˆ˜ë“¤
        let currentStudentStep = 1;
        let selectedEmotion = '';
        window.mindSolverApp = {
            nextStudentStep: (step) => {
                document.querySelector(`#s-step${currentStudentStep}`).style.display = 'none';
                document.querySelector(`#s-step${step}`).style.display = 'block';
                currentStudentStep = step;
            },
            selectEmotion: (emotion) => { selectedEmotion = emotion; window.mindSolverApp.nextStudentStep(2); },
            saveReport: async () => {
                const reportText = document.getElementById('incident-report').value;
                if (!reportText.trim()) { alert('ì–´ë–¤ ì¼ì´ ìˆì—ˆëŠ”ì§€ ì ì–´ì¤˜!'); return; }
                const newReport = { studentName: currentUser.name, emotion: selectedEmotion, text: reportText, timestamp: new Date(), status: 'ë¯¸í•´ê²°', classCode: currentUser.classCode };
                try {
                    const docRef = await addDoc(collection(db, "conflictReports"), newReport);
                    currentReportId = docRef.id;
                    window.mindSolverApp.nextStudentStep(3);
                } catch (e) { console.error("Error adding document: ", e); alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
            },
            updateStatus: async (newStatus) => {
                if (!currentReportId) return;
                try {
                    const reportRef = doc(db, "conflictReports", currentReportId);
                    await updateDoc(reportRef, { status: newStatus });
                    window.mindSolverApp.nextStudentStep(5);
                } catch (e) { console.error("Error updating document: ", e); }
            },
            callTeacher: async () => {
                document.body.style.backgroundColor = '#ff6b6b';
                setTimeout(() => { document.body.style.backgroundColor = '#fff2f2'; }, 1000);
                
                // ì‹¤ì‹œê°„ ì•Œë¦¼ì„ ìœ„í•œ ë°ì´í„° ì €ì¥
                try {
                    await addDoc(collection(db, "helpAlerts"), {
                        classCode: currentUser.classCode,
                        studentName: currentUser.name,
                        timestamp: new Date()
                    });
                } catch (e) {
                    console.error("Error sending help alert: ", e);
                }

                window.mindSolverApp.nextStudentStep(7);
            }
        };

        // --- êµì‚¬ ì•± ì‹œì‘ ---
        function startTeacherApp() {
            teacherView.innerHTML = `
                <div class="header">
                    <h1>${currentUser.classCode}</h1>
                    <button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                <div id="report-list" class="report-container"></div>
            `;
            document.getElementById('logout-btn').onclick = () => {
                if (unsubscribeReports) unsubscribeReports();
                if (unsubscribeAlerts) unsubscribeAlerts();
                location.reload();
            };
            showView(teacherView);
            renderReportsFromFirestore();
            listenForHelpAlerts(); // ì‹¤ì‹œê°„ ì•Œë¦¼ ê°ì§€ ì‹œì‘
        }

        function renderReportsFromFirestore() {
            const reportListContainer = document.getElementById('report-list');
            const q = query(collection(db, "conflictReports"), where("classCode", "==", currentUser.classCode));

            unsubscribeReports = onSnapshot(q, (querySnapshot) => {
                reportListContainer.innerHTML = '';
                if (querySnapshot.empty) { reportListContainer.innerHTML = '<p>ì•„ì§ ì œì¶œëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
                const reports = [];
                querySnapshot.forEach((doc) => reports.push({ id: doc.id, ...doc.data() }));
                reports.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

                reports.forEach(report => {
                    const card = document.createElement('div');
                    card.className = 'report-card';
                    let statusClass = '', statusText = '';
                    switch(report.status) {
                        case 'ìì²´ í•´ê²° ì™„ë£Œ': statusClass = 'self-resolved'; statusText = 'ìì²´ í•´ê²° ì™„ë£Œ'; break;
                        case 'ì§€ë„ ì™„ë£Œ': statusClass = 'teacher-resolved'; statusText = 'ì§€ë„ ì™„ë£Œ'; break;
                        default: statusClass = 'unresolved'; statusText = 'ë¯¸í•´ê²°';
                    }
                    card.innerHTML = `<div class="info"><span><b>í•™ìƒ:</b> ${report.studentName}</span><span class="timestamp">${report.timestamp.toDate().toLocaleString()}</span></div><div class="content"><b>ê°ì •:</b> ${report.emotion}<br><hr><b>ë‚´ìš©:</b><br>${report.text}</div><div class="status ${statusClass}">${statusText}</div><div class="actions"><button onclick="window.teacherApp.markAsResolved('${report.id}')" ${report.status !== 'ë¯¸í•´ê²°' ? 'disabled' : ''}>${report.status === 'ë¯¸í•´ê²°' ? 'ì§€ë„ ì™„ë£Œë¡œ í‘œì‹œ' : 'ì™„ë£Œë¨'}</button></div>`;
                    reportListContainer.appendChild(card);
                });
            });
        }
        
        // ì‹¤ì‹œê°„ ì•Œë¦¼ ê°ì§€ í•¨ìˆ˜
        function listenForHelpAlerts() {
            const q = query(collection(db, "helpAlerts"), where("classCode", "==", currentUser.classCode));
            unsubscribeAlerts = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === "added") {
                        const alertData = change.doc.data();
                        alert(`ğŸ”” ${alertData.studentName} í•™ìƒì´ ë„ì›€ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤!`);
                        // ì•Œë¦¼ì„ ë³´ì—¬ì¤€ í›„, í•´ë‹¹ ì•Œë¦¼ ë¬¸ì„œëŠ” ì‚­ì œí•˜ì—¬ ë°˜ë³µì„ ë°©ì§€
                        await deleteDoc(doc(db, "helpAlerts", change.doc.id));
                    }
                });
            });
        }

        window.teacherApp = {
            markAsResolved: async (docId) => {
                try {
                    const reportRef = doc(db, "conflictReports", docId);
                    await updateDoc(reportRef, { status: 'ì§€ë„ ì™„ë£Œ' });
                } catch(e) { console.error("Error updating document: ", e); }
            }
        };

        // Firebase ì¸ì¦
        (async () => {
            authButtons.forEach(btn => btn.disabled = true);
            try {
                await signInAnonymously(auth);
                console.log("Firebase Auth signed in.");
                authButtons.forEach(btn => btn.disabled = false);
            } catch (error) {
                console.error("Firebase Auth Error: ", error);
                const initialView = document.getElementById('landing-view');
                if(initialView) {
                    initialView.innerHTML = '<h1>ì˜¤ë¥˜ ë°œìƒ</h1><p>ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</p>';
                }
            }
        })();

    </script>
</body>
</html>