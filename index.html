<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마음 해결사</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            font-family: 'Jua', sans-serif;
            /* 배경을 하트 이모지로 변경 */
            background-color: #fff2f2;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='80' opacity='0.08'%3E💖%3C/text%3E%3C/svg%3E");
            background-size: 100px 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .view { display: none; }
        .view.active { display: block; }

        h1 { color: #333; font-size: 2rem; margin-bottom: 15px; text-align: center; }
        p { color: #555; font-size: 1.2rem; line-height: 1.6; text-align: center; }
        
        /* --- 버튼 색상 수정 --- */
        button { 
            font-family: 'Jua', sans-serif; 
            padding: 20px; 
            font-size: 1.3rem; 
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            transition: all 0.2s; 
            background-color: #ffe5e5; /* 기본 버튼 색 (연한 핑크) */
            color: #5c3a3a;
            border-bottom: 5px solid #ffc1c1;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button:active { transform: translateY(1px); border-bottom-width: 2px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; border-bottom-color: #aaa; color: #888; }
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        .full-width-btn { grid-column: 1 / -1; }
        .back-btn { font-size: 1rem; padding: 10px 15px; background-color: #6c757d; color: white; border-bottom-color: #5a6268;}

        /* --- 메인 페이지 스타일 수정 --- */
        #landing-view .landing-header {
            text-align: left;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff6b81;
            margin-bottom: 40px;
        }
        #landing-view .landing-content h1 {
            font-size: 2.8rem;
            color: #333;
            line-height: 1.4;
        }
        #landing-view .landing-content p {
            font-size: 1.3rem;
            color: #666;
            margin-top: 20px;
            margin-bottom: 40px;
        }
        #landing-view .landing-buttons button {
            padding: 20px 30px;
            font-size: 1.5rem;
            color: white;
        }
        #landing-view .teacher-start-btn {
            background-color: #ff8fa3; /* 교사 버튼 (핑크) */
            border-bottom-color: #ff758f;
        }
        #landing-view .student-start-btn {
            background-color: #ffc09f; /* 학생 버튼 (피치) */
            border-bottom-color: #ffab82;
        }
        /* --- 메인 페이지 스타일 끝 --- */

        .form-box input {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            font-family: 'Jua', sans-serif;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
            margin-bottom: 15px;
            text-align: center;
        }
        .form-box { margin-top: 20px; }
        textarea { width: 100%; padding: 15px; font-family: 'Jua', sans-serif; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; margin-top: 15px; resize: vertical; }
        .notice { font-size: 1rem; color: #d9534f; font-weight: bold; background-color: #f9e4e4; padding: 10px; border-radius: 10px; }
        
        /* --- 단계별 버튼 색상 수정 --- */
        button.reason-btn { background-color: #fff3cd; color: #856404; border-color: #f7d97e; }
        button.write-btn { background-color: #e2d1dd; color: #5c3d51; border-color: #c0a3bb; }
        button.dialogue-btn { background-color: #d1e7dd; color: #155724; border-color: #a3cfbb; }
        button.success-btn { background-color: #cff4fc; color: #0c5460; border-color: #9eeaf9; }
        button.help-btn { background-color: #f8d7da; color: #721c24; border-color: #f1aeb5; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #teacher-view { font-family: 'Noto Sans KR', sans-serif; }
        #teacher-view .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #teacher-view .header button { font-size: 1rem; padding: 10px 15px; background-color: #6c757d; color: white; border-bottom-color: #5a6268;}
        #teacher-view .report-container { max-height: 60vh; overflow-y: auto; }
        .report-card { background-color: #fdfdfd; border: 1px solid #eee; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; }
        .report-card .info { display: flex; justify-content: space-between; font-size: 0.9rem; color: #888; margin-bottom: 10px; }
        .report-card .content { font-size: 1rem; background-color: #f9f9f9; padding: 15px; border-radius: 5px; white-space: pre-wrap; margin-bottom: 15px; }
        .report-card .status { font-weight: bold; padding: 5px 10px; border-radius: 5px; text-align: center; margin-bottom: 15px; }
        .status.unresolved { background-color: #ffeeba; color: #856404; }
        .status.self-resolved { background-color: #d4edda; color: #155724; }
        .status.teacher-resolved { background-color: #d1ecf1; color: #0c5460; }
        .report-card .actions button { width: 100%; padding: 10px; font-size: 1rem; background-color: #28a745; color: white; border-bottom-color: #218838;}
        .report-card .actions button:disabled { background-color: #ccc; cursor: not-allowed; border-bottom-color: #aaa; color: #888;}
    </style>
</head>
<body>

    <div class="container">
        <!-- 1. 메인(랜딩) 뷰 -->
        <div id="landing-view" class="view active">
            <div class="landing-header">💖 마음 해결사</div>
            <div class="landing-content">
                <h1>스스로 해결하며 성장하는<br>우리들의 갈등 해결 시간</h1>
                <p>친구와 마음이 맞지 않을 때, 차근차근 내 마음을 표현하고<br>대화로 문제를 해결하는 멋진 어린이가 되어보아요!</p>
            </div>
            <div class="button-grid landing-buttons">
                <button id="teacher-start-btn" class="teacher-start-btn">교사로 시작하기</button>
                <button id="student-start-btn" class="student-start-btn">학생으로 입장하기</button>
            </div>
        </div>

        <!-- 2. 교사용 허브 뷰 -->
        <div id="teacher-hub-view" class="view">
            <h1>교사용 메뉴</h1>
            <p>무엇을 할까요?</p>
            <div class="button-grid">
                <button id="go-to-teacher-login-btn">로그인</button>
                <button id="go-to-signup-btn">학급 만들기</button>
            </div>
            <button class="back-btn full-width-btn" onclick="showView(document.getElementById('landing-view'))">처음으로</button>
        </div>

        <!-- 3. 교사 회원가입 뷰 -->
        <div id="signup-view" class="view">
            <h1>새로운 학급 만들기</h1>
            <div class="form-box">
                <input type="text" id="signup-class-code" placeholder="새로운 학급 코드">
                <input type="password" id="signup-password" placeholder="사용할 비밀번호">
                <button id="signup-btn" class="full-width-btn">만들기</button>
                <button class="back-btn full-width-btn" onclick="showView(document.getElementById('teacher-hub-view'))">뒤로 가기</button>
            </div>
        </div>

        <!-- 4. 학생 로그인 뷰 (분리됨) -->
        <div id="student-login-view" class="view">
            <h1>학생 로그인</h1>
            <div class="form-box">
                <input type="text" id="student-class-code" placeholder="학급 코드">
                <input type="text" id="student-name" placeholder="이름">
                <button id="student-login-btn" class="full-width-btn">입장하기</button>
            </div>
            <button class="back-btn full-width-btn" onclick="showView(document.getElementById('landing-view'))">처음으로</button>
        </div>

        <!-- 5. 교사 로그인 뷰 (분리됨) -->
        <div id="teacher-login-view" class="view">
            <h1>교사 로그인</h1>
            <div class="form-box">
                <input type="text" id="teacher-class-code" placeholder="학급 코드">
                <input type="password" id="teacher-password" placeholder="비밀번호">
                <button id="teacher-login-btn" class="full-width-btn">입장하기</button>
            </div>
            <button class="back-btn full-width-btn" onclick="showView(document.getElementById('teacher-hub-view'))">뒤로 가기</button>
        </div>

        <!-- 6. 학생용 뷰 -->
        <div id="student-view" class="view"></div>
        <!-- 7. 교사용 뷰 -->
        <div id="teacher-view" class="view"></div>
    </div>

    <!-- Firebase SDK 추가 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 선생님의 Firebase 설정 정보입니다.
        const firebaseConfig = {
          apiKey: "AIzaSyAc35ldx-s4Opni4SZ7L8OiwNmjqV5UPJs",
          authDomain: "maeumapple.firebaseapp.com",
          projectId: "maeumapple",
          storageBucket: "maeumapple.appspot.com",
          messagingSenderId: "742281453219",
          appId: "1:742281453219:web:80fa8a3f52d9cda19ae916",
          measurementId: "G-1X3661KSN9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // 전역 변수
        let currentUser = null;
        let currentReportId = null;
        let unsubscribeReports = null;
        let unsubscribeAlerts = null;

        // DOM 요소
        const allViews = document.querySelectorAll('.view');
        const landingView = document.getElementById('landing-view');
        const teacherHubView = document.getElementById('teacher-hub-view');
        const signupView = document.getElementById('signup-view');
        const studentLoginView = document.getElementById('student-login-view');
        const teacherLoginView = document.getElementById('teacher-login-view');
        const studentView = document.getElementById('student-view');
        const teacherView = document.getElementById('teacher-view');
        
        const authButtons = [
            document.getElementById('teacher-start-btn'),
            document.getElementById('student-start-btn'),
            document.getElementById('go-to-teacher-login-btn'),
            document.getElementById('go-to-signup-btn'),
            document.getElementById('signup-btn'),
            document.getElementById('student-login-btn'),
            document.getElementById('teacher-login-btn')
        ];

        // 뷰 전환 함수
        window.showView = (viewToShow) => {
            allViews.forEach(v => v.classList.remove('active'));
            viewToShow.classList.add('active');
        };

        // --- 이벤트 리스너 설정 ---
        document.getElementById('teacher-start-btn').onclick = () => showView(teacherHubView);
        document.getElementById('student-start-btn').onclick = () => showView(studentLoginView);
        document.getElementById('go-to-teacher-login-btn').onclick = () => showView(teacherLoginView);
        document.getElementById('go-to-signup-btn').onclick = () => showView(signupView);
        
        // --- 회원가입 로직 ---
        document.getElementById('signup-btn').onclick = async () => {
            const signupButton = document.getElementById('signup-btn');
            const classCode = document.getElementById('signup-class-code').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            if (!classCode || !password) {
                alert("학급 코드와 비밀번호를 모두 입력해주세요.");
                return;
            }

            signupButton.disabled = true;
            signupButton.innerText = '확인 중...';

            const classRef = doc(db, "classes", classCode);
            
            try {
                const docSnap = await getDoc(classRef);
                if (docSnap.exists()) {
                    alert('가입 실패, 이미 사용된 학급 코드입니다. 다른 학급 코드를 입력해 주세요.');
                } else {
                    await setDoc(classRef, { password: password });
                    alert('가입 성공! 학급코드와 비밀번호를 입력하여 교사 로그인을 해 보세요.');
                    document.getElementById('signup-class-code').value = '';
                    document.getElementById('signup-password').value = '';
                    showView(teacherLoginView);
                }
            } catch (e) {
                console.error("Error during signup: ", e);
                alert("회원가입 중 오류가 발생했습니다.");
            } finally {
                signupButton.disabled = false;
                signupButton.innerText = '만들기';
            }
        };

        // --- 로그인 로직 ---
        document.getElementById('student-login-btn').onclick = async () => {
            const loginButton = document.getElementById('student-login-btn');
            const classCode = document.getElementById('student-class-code').value.trim();
            const name = document.getElementById('student-name').value.trim();
            if (!classCode || !name) { alert("학급 코드와 이름을 모두 입력해주세요."); return; }
            
            loginButton.disabled = true;
            loginButton.innerText = '확인 중...';

            const classRef = doc(db, "classes", classCode);
            
            try {
                const docSnap = await getDoc(classRef);
                if (docSnap.exists()) {
                    currentUser = { role: 'student', name: name, classCode: classCode };
                    startStudentApp();
                } else {
                    alert("학급 코드가 맞는지 확인해주세요.");
                }
            } catch (e) {
                console.error("Error during student login: ", e);
                alert("로그인 중 오류가 발생했습니다.");
            } finally {
                loginButton.disabled = false;
                loginButton.innerText = '입장하기';
            }
        };

        document.getElementById('teacher-login-btn').onclick = async () => {
            const loginButton = document.getElementById('teacher-login-btn');
            const classCode = document.getElementById('teacher-class-code').value.trim();
            const password = document.getElementById('teacher-password').value.trim();
            if (!classCode || !password) { alert("학급 코드와 비밀번호를 모두 입력해주세요."); return; }

            loginButton.disabled = true;
            loginButton.innerText = '확인 중...';

            const classRef = doc(db, "classes", classCode);
            
            try {
                const docSnap = await getDoc(classRef);
                if (docSnap.exists() && docSnap.data().password === password) {
                    currentUser = { role: 'teacher', classCode: classCode };
                    startTeacherApp();
                } else {
                    alert("학급 코드 또는 비밀번호가 맞지 않습니다.");
                }
            } catch (e) {
                console.error("Error during teacher login: ", e);
                alert("로그인 중 오류가 발생했습니다.");
            } finally {
                loginButton.disabled = false;
                loginButton.innerText = '입장하기';
            }
        };
        
        // --- 학생 앱 시작 ---
        function startStudentApp() {
            studentView.innerHTML = `
                <div id="s-step1" class="s-step" style="display: block;">
                    <h1>속상한 일이 있었구나, ${currentUser.name}.</h1>
                    <p>지금 너의 마음과 가장 비슷한 감정은 무엇이니?</p>
                    <div class="button-grid">
                        <button class="reason-btn" onclick="mindSolverApp.selectEmotion('😡 화가 나요')">😡 화가 나요</button>
                        <button class="reason-btn" onclick="mindSolverApp.selectEmotion('😭 슬퍼요')">😭 슬퍼요</button>
                        <button class="reason-btn" onclick="mindSolverApp.selectEmotion('😟 억울해요')">😟 억울해요</button>
                        <button class="reason-btn" onclick="mindSolverApp.selectEmotion('😰 답답해요')">😰 답답해요</button>
                    </div>
                </div>
                <div id="s-step2" class="s-step" style="display: none;"><h1>어떤 일이 있었는지 알려줄래?</h1><p class="notice">언제, 어디서, 누가, 어떤 말이나 행동을 했는지<br>정확한 사실만 적어줘.</p><textarea id="incident-report" rows="6" placeholder="여기에 있었던 일을 차근차근 적어보자..."></textarea><div class="button-grid"><button class="write-btn full-width-btn" onclick="mindSolverApp.saveReport()">다 적었어요</button></div></div>
                <div id="s-step3" class="s-step" style="display: none;"><h1>잘 적어주었어. 이제 너의 마음을 친구에게 이야기해볼까?</h1><p>"나는 네가 (  )행동을 해서, (  )감정이 들었어."<br>이렇게 솔직하게 말해보는 건 어때?</p><div class="button-grid"><button class="dialogue-btn full-width-btn" onclick="mindSolverApp.nextStudentStep(4)">좋아요, 용기 내볼게요!</button></div></div>
                <div id="s-step4" class="s-step" style="display: none;"><h1>친구와 이야기해보니 어땠어?</h1><p>마음이 잘 해결되었는지 알려줘!</p><div class="button-grid"><button class="success-btn" onclick="mindSolverApp.updateStatus('자체 해결 완료')">네, 잘 해결됐어요!</button><button class="help-btn" onclick="mindSolverApp.nextStudentStep(6)">아니요, 도움이 필요해요</button></div></div>
                <div id="s-step5" class="s-step" style="display: none;"><h1>정말 멋지다!</h1><p>대화로 문제를 해결한 너희 모두가 자랑스러워!<br>다시 처음으로 돌아가려면 아래 버튼을 눌러줘.</p><div class="button-grid"><button class="full-width-btn" onclick="location.reload()">처음으로</button></div></div>
                <div id="s-step6" class="s-step" style="display: none;">
                    <h1>혼자 해결하기 어려울 땐,<br>선생님의 도움이 힘이 될 수 있어.</h1>
                    <p>괜찮아, 용기 내어 선생님께 도움을 요청드려보자.<br>아래 버튼을 누르면 선생님께 알림이 갈 거야.</p>
                    <div class="button-grid">
                        <button id="teacher-call-btn" class="full-width-btn" onclick="mindSolverApp.callTeacher()">🚨 선생님! 도와주세요! 🚨</button>
                    </div>
                </div>
                <div id="s-step7" class="s-step" style="display: none;">
                    <h1>선생님께 알렸어요!</h1>
                    <p>선생님과 이야기하고 문제가 해결되면<br>아래 버튼을 눌러 마무리해주세요.</p>
                    <div class="button-grid">
                        <button class="success-btn full-width-btn" onclick="location.reload()">해결됐어요!</button>
                    </div>
                </div>
            `;
            showView(studentView);
        }
        
        // 학생용 앱 함수들
        let currentStudentStep = 1;
        let selectedEmotion = '';
        window.mindSolverApp = {
            nextStudentStep: (step) => {
                document.querySelector(`#s-step${currentStudentStep}`).style.display = 'none';
                document.querySelector(`#s-step${step}`).style.display = 'block';
                currentStudentStep = step;
            },
            selectEmotion: (emotion) => { selectedEmotion = emotion; window.mindSolverApp.nextStudentStep(2); },
            saveReport: async () => {
                const reportText = document.getElementById('incident-report').value;
                if (!reportText.trim()) { alert('어떤 일이 있었는지 적어줘!'); return; }
                const newReport = { studentName: currentUser.name, emotion: selectedEmotion, text: reportText, timestamp: new Date(), status: '미해결', classCode: currentUser.classCode };
                try {
                    const docRef = await addDoc(collection(db, "conflictReports"), newReport);
                    currentReportId = docRef.id;
                    window.mindSolverApp.nextStudentStep(3);
                } catch (e) { console.error("Error adding document: ", e); alert("오류가 발생했습니다."); }
            },
            updateStatus: async (newStatus) => {
                if (!currentReportId) return;
                try {
                    const reportRef = doc(db, "conflictReports", currentReportId);
                    await updateDoc(reportRef, { status: newStatus });
                    window.mindSolverApp.nextStudentStep(5);
                } catch (e) { console.error("Error updating document: ", e); }
            },
            callTeacher: async () => {
                document.body.style.backgroundColor = '#ff6b6b';
                setTimeout(() => { document.body.style.backgroundColor = '#fff2f2'; }, 1000);
                
                // 실시간 알림을 위한 데이터 저장
                try {
                    await addDoc(collection(db, "helpAlerts"), {
                        classCode: currentUser.classCode,
                        studentName: currentUser.name,
                        timestamp: new Date()
                    });
                } catch (e) {
                    console.error("Error sending help alert: ", e);
                }

                window.mindSolverApp.nextStudentStep(7);
            }
        };

        // --- 교사 앱 시작 ---
        function startTeacherApp() {
            teacherView.innerHTML = `
                <div class="header">
                    <h1>${currentUser.classCode}</h1>
                    <button id="logout-btn">로그아웃</button>
                </div>
                <div id="report-list" class="report-container"></div>
            `;
            document.getElementById('logout-btn').onclick = () => {
                if (unsubscribeReports) unsubscribeReports();
                if (unsubscribeAlerts) unsubscribeAlerts();
                location.reload();
            };
            showView(teacherView);
            renderReportsFromFirestore();
            listenForHelpAlerts(); // 실시간 알림 감지 시작
        }

        function renderReportsFromFirestore() {
            const reportListContainer = document.getElementById('report-list');
            const q = query(collection(db, "conflictReports"), where("classCode", "==", currentUser.classCode));

            unsubscribeReports = onSnapshot(q, (querySnapshot) => {
                reportListContainer.innerHTML = '';
                if (querySnapshot.empty) { reportListContainer.innerHTML = '<p>아직 제출된 내용이 없습니다.</p>'; return; }
                const reports = [];
                querySnapshot.forEach((doc) => reports.push({ id: doc.id, ...doc.data() }));
                reports.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

                reports.forEach(report => {
                    const card = document.createElement('div');
                    card.className = 'report-card';
                    let statusClass = '', statusText = '';
                    switch(report.status) {
                        case '자체 해결 완료': statusClass = 'self-resolved'; statusText = '자체 해결 완료'; break;
                        case '지도 완료': statusClass = 'teacher-resolved'; statusText = '지도 완료'; break;
                        default: statusClass = 'unresolved'; statusText = '미해결';
                    }
                    card.innerHTML = `<div class="info"><span><b>학생:</b> ${report.studentName}</span><span class="timestamp">${report.timestamp.toDate().toLocaleString()}</span></div><div class="content"><b>감정:</b> ${report.emotion}<br><hr><b>내용:</b><br>${report.text}</div><div class="status ${statusClass}">${statusText}</div><div class="actions"><button onclick="window.teacherApp.markAsResolved('${report.id}')" ${report.status !== '미해결' ? 'disabled' : ''}>${report.status === '미해결' ? '지도 완료로 표시' : '완료됨'}</button></div>`;
                    reportListContainer.appendChild(card);
                });
            });
        }
        
        // 실시간 알림 감지 함수
        function listenForHelpAlerts() {
            const q = query(collection(db, "helpAlerts"), where("classCode", "==", currentUser.classCode));
            unsubscribeAlerts = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === "added") {
                        const alertData = change.doc.data();
                        alert(`🔔 ${alertData.studentName} 학생이 도움을 요청했습니다!`);
                        // 알림을 보여준 후, 해당 알림 문서는 삭제하여 반복을 방지
                        await deleteDoc(doc(db, "helpAlerts", change.doc.id));
                    }
                });
            });
        }

        window.teacherApp = {
            markAsResolved: async (docId) => {
                try {
                    const reportRef = doc(db, "conflictReports", docId);
                    await updateDoc(reportRef, { status: '지도 완료' });
                } catch(e) { console.error("Error updating document: ", e); }
            }
        };

        // Firebase 인증
        (async () => {
            authButtons.forEach(btn => btn.disabled = true);
            try {
                await signInAnonymously(auth);
                console.log("Firebase Auth signed in.");
                authButtons.forEach(btn => btn.disabled = false);
            } catch (error) {
                console.error("Firebase Auth Error: ", error);
                const initialView = document.getElementById('landing-view');
                if(initialView) {
                    initialView.innerHTML = '<h1>오류 발생</h1><p>인증에 실패했습니다. 페이지를 새로고침 해주세요.</p>';
                }
            }
        })();

    </script>
</body>
</html>